<script>
    let lastSeenId = null;
    const errorSection = document.getElementById('error-section');
    const eventsList = document.getElementById('events-list');

    // Fetch events from the backend
    async function fetchEvents() {
        try {
            errorSection.style.display = 'none';
            let url = "{{ url_for('events.get_events') }}";
            // Build the URL with a query parameter if we have a lastSeenId
            if (lastSeenId) {
                url += `?mongoId=${lastSeenId}`;
            }

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Failed to fetch events, Error ${response.status}`);
            }

            const events = await response.json();
            displayEvents(events);

            if (events.length > 0) {
                lastSeenId = events[events.length - 1]._id;
            }
        } catch (error) {
            console.error('Error fetching events:', error);
            showError(`Failed to fetch events: ${error.message}`);
        }
    }

    // Display events in the list
    function displayEvents(events) {
        if (events.length === 0) {
            eventsList.innerHTML = `
                <div class="list-item no-events">
                    <p>No new events in the last 15 seconds</p>
                </div>
            `;
            return;
        }
        // Clear the list
        eventsList.innerHTML = '';
        events.forEach(event => {
            const listItem = createEventItem(event);
            eventsList.appendChild(listItem);
        });
    }

    // Create a list item element for an event
    function createEventItem(event) {
        const div = document.createElement('div');
        div.className = 'list-item';

        // Format the timestamp with ordinal suffix
        console.log(event.timestamp.$date)
        const date = new Date(event.timestamp.$date);
        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };

        const timestamp = new Intl.DateTimeFormat('en-US', options).format(date);

        // Format event description based on action type
        let cname = ""
        let description = '';
        const author = event.author;
        let svg_file = "";
        
        switch (event.action) {
            case 'PUSH':
                const pushBranch = event.to_branch;
                description = `${author} pushed to "${pushBranch}" on ${timestamp}`;
                cname = "push-item"
                break;
            case 'PULL_REQUEST':
                const fromBranch = event.from_branch;
                const toBranch = event.to_branch;
                description = `${author} submitted a pull request from "${fromBranch}" to "${toBranch}" on ${timestamp}`;
                cname = 'pr-item'
                break;
            case 'MERGE':
                const mergeFromBranch = event.from_branch;
                const mergeToBranch = event.to_branch;
                description = `${author} merged branch "${mergeFromBranch}" to "${mergeToBranch}" on ${timestamp}`;
                cname = 'merge-item'
                break;
            default:
                description = `${author} performed ${event.action || 'unknown'} on ${timestamp}`;
        }
        
        div.classList.add(cname);

        // Create content HTML
        const content = document.createElement('div');
        content.className = 'event-item';

        const p = document.createElement('p');
        p.textContent = description;

        content.appendChild(p);
        div.appendChild(content);
        return div;
    }

    // Show error message
    function showError(message) {
        const errorSection = document.getElementById('error-section');
        const errorMessage = document.getElementById('error-message');
        errorMessage.textContent = message;
        errorSection.style.display = 'block';
    }

    fetchEvents(); // Initial fetch
    setInterval(fetchEvents, 15000);
</script>